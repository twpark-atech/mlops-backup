# docker/docker-compose.core.yml
services:
  # KRaft 모드의 단일 Kafka 브로커 (ZooKeeper 필요 없음)
  broker:
    image: apache/kafka:latest
    container_name: mlops-kafka-broker
    hostname: broker
    ports:
      - "9092:9092"          # 로컬 PC에서 접속할 포트
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT,CONTROLLER:PLAINTEXT
      # 컨테이너 내부에서 사용할 리스너들
      KAFKA_LISTENERS: PLAINTEXT://broker:29092,CONTROLLER://broker:29093,PLAINTEXT_HOST://0.0.0.0:9092
      # 내부 클러스터 통신용 리스너 이름
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      # 외부/내부 접속 시 광고할 주소
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://broker:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      # KRaft 모드 설정
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_NODE_ID: 1
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@broker:29093
      KAFKA_LOG_DIRS: /tmp/kraft-combined-logs
      # 단일 브로커라서 replication 관련 값들 1로 고정
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      # 아무 값이나 고유하게 하나
      CLUSTER_ID: MkU3OEVBNTcwNTJENDM2Qk
    networks:
      - data_pipeline

  minio:
    image: minio/minio:RELEASE.2025-06-13T11-33-47Z
    container_name: mlops-minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: miniostorage
    command: server /data --console-address ":9001"
    volumes:
      - minio-data:/data
    networks:
      - data_pipeline

  minio-client:
    image: minio/mc
    container_name: mlops-minio-client
    depends_on:
      - minio
    restart: "no"
    entrypoint: >
      /bin/sh -c "
        sleep 5 &&
        mc alias set local http://minio:9000 minio miniostorage &&
        mc mb -p local/its &&
        mc policy set public local/its;
        exit 0;
      "
    networks:
      - data_pipeline

  postgres:
    image: postgres:16.9
    container_name: mlops-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: mlops
    ports:
      - "5431:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./config/postgres-init.sql:/docker-entrypoint-initdb.d/01-init.sql
    networks:
      - data_pipeline

  mlflow:
    build:
      context: ..
      dockerfile: docker/Dockerfile.mlflow
    container_name: mlops-mlflow
    depends_on:
      - postgres
      - minio
    environment:
      MLFLOW_BACKEND_STORE_URI: postgresql://postgres:postgres@postgres:5432/mlops
      MLFLOW_ARTIFACT_ROOT: s3://its/mlflow/
      AWS_ACCESS_KEY_ID: minio
      AWS_SECRET_ACCESS_KEY: miniostorage
      MLFLOW_S3_ENDPOINT_URL: http://minio:9000
    command: >
      mlflow server
      --backend-store-uri postgresql://postgres:postgres@postgres:5432/mlops
      --host 0.0.0.0
      --port 5000
      --default-artifact-root s3://its/mlflow/
    ports:
      - "5000:5000"
    networks:
      - data_pipeline


  # ITS ZIP → MinIO + Kafka 이벤트 발행하는 파이썬 인제스터
  file-ingestor:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: mlops-file-ingestor
    depends_on:
      - broker
      - minio
      - minio-client
    env_file:
      - .env
    volumes:
      - ../config:/app/config
    networks:
      - data_pipeline
    command: ["python", "-m", "src.ingestion.file_ingestor.main"]

  jupyter:
    build:
      context: ..
      dockerfile: docker/Dockerfile.jupyter
    container_name: mlops-jupyter
    depends_on:
      - postgres
      - minio
      - mlflow
    ports:
      - "8888:8888"
    volumes:
      - ..:/workspace
    working_dir: /workspace
    environment:
      JUPYTER_TOKEN: mlops
      MLFLOW_TRACKING_URI: http://mlflow:5000
      PG_HOST: postgres
      PG_PORT: 5432
      PG_DB: mlops
      PG_USER: postgres
      PG_PASSWORD: postgres
      S3_ENDPOINT: http://minio:9000
      MINIO_ACCESS_KEY: minio
      MINIO_SECRET_KEY: miniostorage
    command: >
      start-notebook.sh
      --NotebookApp.token='mlops'
      --NotebookApp.allow_origin='*'
    networks:
      - data_pipeline

  airflow:
    build:
      context: ..
      dockerfile: docker/Dockerfile.airflow
    container_name: mlops-airflow
    depends_on:
      - postgres
      - minio
      - broker
      - mlflow
    environment:
      # Airflow 설정
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
      AIRFLOW__CORE__FERNET_KEY: "THIS_IS_A_RANDOM_FERNET_KEY_CHANGE_ME"
      AIRFLOW__CORE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres:5432/airflow
      AIRFLOW__CORE__DEFAULT_TIMEZONE: "Asia/Seoul"
      AIRFLOW__WEBSERVER__DEFAULT_UI_TIMEZONE: "Asia/Seoul"
      AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION: "False"

      # 파이프라인/학습 코드에서 쓰는 환경변수들
      PG_HOST: postgres
      PG_PORT: "5432"      # 컨테이너 간 통신은 5432
      PG_DB: mlops
      PG_USER: postgres
      PG_PASSWORD: postgres

      MLFLOW_TRACKING_URI: http://mlflow:5000
      AWS_ACCESS_KEY_ID: minio
      AWS_SECRET_ACCESS_KEY: miniostorage
      MLFLOW_S3_ENDPOINT_URL: http://minio:9000
    ports:
      - "8080:8080"   # Airflow 웹 UI
    command: >
      bash -c "
        airflow db upgrade &&
        airflow users create
          --username admin
          --password admin
          --firstname Admin
          --lastname User
          --role Admin
          --email admin@example.com || true &&
        airflow webserver --port 8080 & 
        airflow scheduler
      "
    volumes:
      - airflow-logs:/opt/airflow/logs
    networks:
      - data_pipeline

volumes:
  minio-data:
  postgres-data:
  airflow-logs:

networks:
  data_pipeline:
    driver: bridge
